<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Proyectos</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body>
    <!-- Gesti√≥n de Tableros -->
    <div class="mb-3 p-3 board-management">
        <div class="row align-items-center">
            <div class="col-md-4">
                <label for="boardSelector" class="form-label mb-1">
                    <i class="bi bi-kanban me-1"></i>Tablero Actual:
                </label>
                <div class="current-board-indicator">
                    <select id="boardSelector" class="form-select" onchange="BoardController.handleBoardChange(this.value)">
                        <!-- Las opciones se llenar√°n din√°micamente -->
                    </select>
                </div>
            </div>
            <div class="col-md-8 mt-2 mt-md-0">
                <div class="d-flex gap-2 flex-wrap">
                    <button type="button" class="btn btn-success btn-sm" onclick="BoardController.showCreateBoardModal()" title="Crear nuevo tablero">
                        <i class="bi bi-plus-square me-1"></i>Nuevo Tablero
                    </button>
                    <button type="button" class="btn btn-warning btn-sm" onclick="BoardController.showRenameBoardModal()" title="Renombrar tablero actual">
                        <i class="bi bi-pencil me-1"></i>Renombrar
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="BoardController.confirmDeleteBoard()" title="Eliminar tablero actual">
                        <i class="bi bi-trash me-1"></i>Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Botones de acciones principales -->
    <div class="mb-3 d-flex gap-2">
        <button type="button" class="btn btn-primary btn-lg" onclick="openCreateModal()">
            <i class="bi bi-plus-circle me-2"></i>Crear Nuevo
        </button>
        <button type="button" class="btn btn-outline-success btn-lg" onclick="StorageController.exportStorage()">
            <i class="bi bi-download me-2"></i>Exportar Tablero
        </button>
        <label class="btn btn-outline-info btn-lg mb-0" style="cursor:pointer;">
            <i class="bi bi-upload me-2"></i>Importar Tablero
            <input type="file" id="importStorageInput" accept="application/json" style="display:none;" onchange="StorageController.importStorage(event)">
        </label>
    </div>

    <!-- Incluir Modal de Creaci√≥n -->
    <div id="modalContainer"></div>

    <div class="container">
        <table id="projectTable">
            <thead>
                <tr>
                    <th>Proyecto</th>
                    <th>Tarea</th>
                    <th>Descripci√≥n breve</th>
                    <th>Prioridad</th>
                    <th>Avance</th>
                    <th>Esfuerzo (d√≠as/semanas)</th>
                    <th>DeadLine</th>
                    <th>Estado</th>
                    <th style="width: 60px;">Acciones</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Cargar los datos de proyectos y reglas de negocio desde archivo externo -->
    <script src="proyectosData.js"></script>
    <script src="reglasNegocio.js"></script>
    <script src="storageController.js"></script>
    <script src="boardController.js"></script>
    <script src="formController.js"></script>
    <script>
        // Funci√≥n para renderizar la tabla recursivamente
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            window.proyectosData.forEach((proyecto, index) => {
                renderElement(proyecto, [index], 0, tbody);
            });

        // Funci√≥n recursiva para renderizar elementos
        function renderElement(elemento, elementPath, level, container) {
            const isProject = level === 0;
            const pathString = elementPath.join('-');
            
            // Crear fila del elemento
            const elementRow = document.createElement('tr');
            elementRow.className = isProject ? 'proyecto-row' : (level === 1 ? 'tarea-row' : 'subtarea-row');
            if (!isProject && Array.isArray(elemento.elementos) && elemento.elementos.length > 0) {
                elementRow.className += ' tarea-con-subtareas';
            }
            
            elementRow.dataset.elementPath = pathString;
            if (isProject) elementRow.dataset.projectIndex = elementPath[0];

            // Construir contenido de la fila
            let rowContent = '';
            
            if (isProject) {
                // Fila de proyecto
                rowContent = `
                    <td class="proyecto-nombre" data-field="nombre">
                        <div class="project-controls">
                            <button class="reorder-btn" onclick="moveProject(${elementPath[0]}, 'up')" title="Mover proyecto hacia arriba" ${elementPath[0] === 0 ? 'disabled' : ''}>
                                ‚Üë
                            </button>
                            <button class="reorder-btn" onclick="moveProject(${elementPath[0]}, 'down')" title="Mover proyecto hacia abajo" ${elementPath[0] === window.proyectosData.length - 1 ? 'disabled' : ''}>
                                ‚Üì
                            </button>
                            <button class="collapse-btn" onclick="StorageController.toggleProjectPersistent(${elementPath[0]})" id="btn-${elementPath[0]}" title="Contraer/Expandir proyecto">
                                <span class="collapse-icon">‚ñº</span>
                            </button>
                        </div>
                        ${escapeHtml(elemento.nombre)}
                    </td>
                    <td colspan="2" class="descripcion-proyecto" data-field="descripcion">${escapeHtml(elemento.descripcion || '')}</td>
                    <td colspan="5"></td>
                    <td class="actions-cell">
                        <div class="dropdown">
                            <button class="btn action-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                ‚öôÔ∏è
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" onclick="StorageController.editRow([${elementPath.join(',')}])">‚úèÔ∏è Editar</a></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="StorageController.deleteElement([${elementPath.join(',')}])">üóëÔ∏è Eliminar</a></li>
                            </ul>
                        </div>
                    </td>
                `;
            } else {
                // Fila de elemento hijo
                const indent = level * 20;
                const icon = level === 1 ? 'üìù' : 'üìÑ';
                rowContent = `
                    <td data-field="nombre" style="padding-left: ${indent}px;">
                        ${icon} <strong>${escapeHtml(elemento.nombre)}</strong>
                    </td>
                    <td data-field="descripcion">${escapeHtml(elemento.descripcion || '')}</td>
                    <td data-field="prioridad" class="prioridad">${escapeHtml(elemento.prioridad || '')}</td>
                    <td data-field="avance" class="avance">${escapeHtml(elemento.avance || '')}</td>
                    <td data-field="esfuerzo" class="esfuerzo">${escapeHtml(elemento.esfuerzo || '')}</td>
                    <td data-field="deadline">${escapeHtml(elemento.deadline || '')}</td>
                    <td>
                        <select class="estado estado-select" data-current="${elemento.estado || 'Pendiente'}" 
                                onchange="StorageController.updateElementEstado([${elementPath.join(',')}], this.value)">
                            <option value="Pendiente" ${(elemento.estado || 'Pendiente') === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                            <option value="En progreso" ${elemento.estado === 'En progreso' ? 'selected' : ''}>En progreso</option>
                            <option value="Completado" ${elemento.estado === 'Completado' ? 'selected' : ''}>Completado</option>
                            <option value="Bloqueado" ${elemento.estado === 'Bloqueado' ? 'selected' : ''}>Bloqueado</option>
                        </select>
                    </td>
                    <td class="actions-cell">
                        <div class="dropdown">
                            <button class="btn action-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                ‚öôÔ∏è
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" onclick="StorageController.editRow([${elementPath.join(',')}])">‚úèÔ∏è Editar</a></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="StorageController.deleteElement([${elementPath.join(',')}])">üóëÔ∏è Eliminar</a></li>
                            </ul>
                        </div>
                    </td>
                `;
            }

            elementRow.innerHTML = rowContent;
            container.appendChild(elementRow);

            if (isProject) {
                // A√±adir fila de resumen para proyectos
                const totalElementos = window.reglasNegocio.contarElementosRecursivo(elemento) - 1; // -1 para no contar el proyecto mismo
                const avanceGeneral = window.reglasNegocio.calcularAvanceGeneral(elemento);
                
                const recuentoRow = document.createElement('tr');
                recuentoRow.className = 'recuento-row';
                recuentoRow.dataset.projectIndex = elementPath[0];
                recuentoRow.innerHTML = `
                    <td>Elementos: ${totalElementos}</td>
                    <td colspan="2">Avance general: <strong>${avanceGeneral}%</strong></td>
                    <td colspan="5"></td>
                    <td></td>
                `;
                container.appendChild(recuentoRow);
            }

            // Renderizar elementos hijos recursivamente
            if (Array.isArray(elemento.elementos)) {
                elemento.elementos.forEach((hijo, hijoIndex) => {
                    const childPath = [...elementPath, hijoIndex];
                    renderElement(hijo, childPath, level + 1, container);
                });
            }
        }

        // Funci√≥n auxiliar para migrar datos antiguos a nueva estructura
        function migrateOldData() {
            let needsMigration = false;
            
            window.proyectosData.forEach((proyecto) => {
                // Migrar proyectos que tienen la estructura antigua
                if (proyecto.tareas && !proyecto.elementos) {
                    proyecto.elementos = proyecto.tareas.map(tarea => {
                        const elemento = {
                            nombre: tarea.nombre,
                            descripcion: tarea.descripcion || '',
                            tipo: 'tarea',
                            prioridad: tarea.prioridad || '',
                            avance: tarea.avance || '',
                            esfuerzo: tarea.esfuerzo || '',
                            deadline: tarea.deadline || '',
                            estado: tarea.estado || 'Pendiente',
                            elementos: []
                        };
                        
                        // Migrar subtareas si existen
                        if (Array.isArray(tarea.subtareas)) {
                            elemento.elementos = tarea.subtareas.map(subtarea => ({
                                nombre: subtarea.nombre,
                                descripcion: subtarea.descripcion || '',
                                tipo: 'subtarea',
                                prioridad: subtarea.prioridad || '',
                                avance: subtarea.avance || '',
                                esfuerzo: subtarea.esfuerzo || '',
                                deadline: subtarea.deadline || '',
                                estado: subtarea.estado || 'Pendiente',
                                elementos: []
                            }));
                        }
                        
                        return elemento;
                    });
                    
                    // Eliminar las propiedades antiguas
                    delete proyecto.tareas;
                    delete proyecto.recuento;
                    
                    // Agregar propiedades necesarias si no existen
                    if (!proyecto.tipo) proyecto.tipo = 'proyecto';
                    if (!proyecto.avance) proyecto.avance = '';
                    if (!proyecto.prioridad) proyecto.prioridad = '';
                    if (!proyecto.esfuerzo) proyecto.esfuerzo = '';
                    if (!proyecto.deadline) proyecto.deadline = '';
                    if (!proyecto.estado) proyecto.estado = 'Pendiente';
                    
                    needsMigration = true;
                }
            });
            
            // Guardar los datos migrados
            if (needsMigration) {
                StorageController.save();
                StorageController.notify('Datos migrados a nueva estructura recursiva', 'success');
            }
        }
            if (window.proyectosData && window.proyectosData.length > 0) {
                // Verificar y migrar datos antiguos si es necesario
                migrateOldData();
            }
        }

        // Funci√≥n para colapsar/expandir proyectos
        function toggleProject(index) {
            const projectRow = document.querySelector(`tr.proyecto-row[data-project-index="${index}"]`);
            const button = document.getElementById(`btn-${index}`);
            const icon = button.querySelector('.collapse-icon');
            const relatedRows = document.querySelectorAll(`tr[data-project-index="${index}"]:not(.proyecto-row)`);
            
            if (projectRow.classList.contains('proyecto-collapsed')) {
                // Expandir
                projectRow.classList.remove('proyecto-collapsed');
                icon.textContent = '‚ñº';
                button.title = 'Contraer proyecto';
                relatedRows.forEach(row => {
                    row.style.display = '';
                });
            } else {
                // Colapsar
                projectRow.classList.add('proyecto-collapsed');
                icon.textContent = '‚ñ∂';
                button.title = 'Expandir proyecto';
                relatedRows.forEach(row => {
                    row.style.display = 'none';
                });
            }
        }

        // Funci√≥n para reordenar proyectos
        function moveProject(index, direction) {
            const currentProject = window.proyectosData[index];
            let newIndex;
            
            if (direction === 'up' && index > 0) {
                newIndex = index - 1;
            } else if (direction === 'down' && index < window.proyectosData.length - 1) {
                newIndex = index + 1;
            } else {
                return; // No se puede mover
            }
            
            // Intercambiar proyectos en el array
            const projectToSwap = window.proyectosData[newIndex];
            window.proyectosData[index] = projectToSwap;
            window.proyectosData[newIndex] = currentProject;
            
            // Guardar estados de colapso antes de re-renderizar
            const collapsedStates = {};
            window.proyectosData.forEach((_, i) => {
                const projectRow = document.querySelector(`tr.proyecto-row[data-project-index="${i}"]`);
                if (projectRow) {
                    collapsedStates[i] = projectRow.classList.contains('proyecto-collapsed');
                }
            });
            
            // Re-renderizar la tabla
            renderTable();
            
            // Restaurar estados de colapso (intercambiados)
            const tempCollapsed = collapsedStates[index];
            collapsedStates[index] = collapsedStates[newIndex];
            collapsedStates[newIndex] = tempCollapsed;
            
            Object.keys(collapsedStates).forEach(i => {
                if (collapsedStates[i]) {
                    toggleProject(parseInt(i));
                }
            });
            
            // Guardar los nuevos estados de colapso
            setTimeout(() => {
                StorageController.saveCollapsedStates();
            }, 100);
            
            // Agregar efecto visual de movimiento
            const movedProjectRow = document.querySelector(`tr.proyecto-row[data-project-index="${newIndex}"]`);
            if (movedProjectRow) {
                movedProjectRow.classList.add('move-animation');
                setTimeout(() => {
                    movedProjectRow.classList.remove('move-animation');
                }, 300);
            }
            
            // Guardar cambios en el storage
            StorageController.save();
            
            // Mostrar feedback visual
            showMoveConfirmation(currentProject.nombre, direction);
        }



        // Funci√≥n para mostrar confirmaci√≥n de movimiento
        function showMoveConfirmation(projectName, direction) {
            const message = `Proyecto "${projectName}" movido hacia ${direction === 'up' ? 'arriba' : 'abajo'}`;
            StorageController.notify(message, 'success');
        }

        // Funci√≥n para actualizar estado (wrapper global)
        function updateEstado(type, projectIndex, taskIndex, subtaskIndex, newEstado) {
            StorageController.updateEstado(type, projectIndex, taskIndex, subtaskIndex, newEstado);
        }

        // Funci√≥n para abrir modal de creaci√≥n
        async function openCreateModal() {
            try {
                // Cargar el HTML del modal si no est√° cargado
                const modalContainer = document.getElementById('modalContainer');
                if (!modalContainer.innerHTML.trim()) {
                    const response = await fetch('create-forms.html');
                    const html = await response.text();
                    modalContainer.innerHTML = html;
                    
                    // Inicializar el FormController despu√©s de cargar el HTML
                    if (window.FormController) {
                        window.FormController.init();
                    }
                }
                
                // Abrir el modal
                if (window.FormController) {
                    window.FormController.openModal('project');
                }
            } catch (error) {
                console.error('Error al cargar el modal:', error);
                StorageController.notify('Error al cargar el formulario de creaci√≥n', 'error');
            }
        }

        // Inicializar la aplicaci√≥n al cargar la p√°gina
        

        // Funci√≥n para cancelar edici√≥n
        function cancelEdit() {
            if (!currentlyEditing) return;
            
            // Re-renderizar para restaurar estado original
            renderTable();
            currentlyEditing = null;
        }

        // Funci√≥n para eliminar elemento
        function deleteRow(type, projectIndex, taskIndex = null, subtaskIndex = null) {
            let itemName = '';
            let confirmMessage = '';
            
            // Determinar qu√© se va a eliminar
            if (type === 'project') {
                itemName = window.proyectosData[projectIndex].nombre;
                confirmMessage = `¬øEst√°s seguro de que deseas eliminar el proyecto "${itemName}" y todas sus tareas?`;
            } else if (type === 'task') {
                itemName = window.proyectosData[projectIndex].tareas[taskIndex].nombre;
                confirmMessage = `¬øEst√°s seguro de que deseas eliminar la tarea "${itemName}"${window.proyectosData[projectIndex].tareas[taskIndex].subtareas ? ' y todas sus subtareas' : ''}?`;
            } else if (type === 'subtask') {
                itemName = window.proyectosData[projectIndex].tareas[taskIndex].subtareas[subtaskIndex].nombre;
                confirmMessage = `¬øEst√°s seguro de que deseas eliminar la subtarea "${itemName}"?`;
            }
            
            // Mostrar confirmaci√≥n
            if (confirm(confirmMessage)) {
                try {
                    if (type === 'project') {
                        window.proyectosData.splice(projectIndex, 1);
                    } else if (type === 'task') {
                        window.proyectosData[projectIndex].tareas.splice(taskIndex, 1);
                        // Actualizar recuento del proyecto
                        window.proyectosData[projectIndex].recuento = window.proyectosData[projectIndex].tareas.length;
                    } else if (type === 'subtask') {
                        window.proyectosData[projectIndex].tareas[taskIndex].subtareas.splice(subtaskIndex, 1);
                        // Si no quedan subtareas, eliminar el array
                        if (window.proyectosData[projectIndex].tareas[taskIndex].subtareas.length === 0) {
                            delete window.proyectosData[projectIndex].tareas[taskIndex].subtareas;
                        }
                    }
                    
                    // Guardar cambios
                    StorageController.save();
                    StorageController.notify(`${type === 'project' ? 'Proyecto' : type === 'task' ? 'Tarea' : 'Subtarea'} "${itemName}" eliminado correctamente`, 'success');
                    
                    // Re-renderizar tabla
                    renderTable();
                    
                } catch (error) {
                    console.error('Error al eliminar:', error);
                    StorageController.notify('Error al eliminar el elemento', 'error');
                }
            }
        }

        // Funci√≥n auxiliar para escapar HTML
        function escapeHtml(text) {
            // Manejar valores null, undefined o vac√≠os
            if (text === null || text === undefined) {
                return '';
            }
            
            // Convertir a string si no lo es
            const str = String(text);
            
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return str.replace(/[&<>"']/g, function(m) { return map[m]; });
        }


        // Inicializar la aplicaci√≥n al cargar la p√°gina
        function initializeApp() {
            // Inicializar sistema de tableros
            BoardController.initializeBoards();
            // Cargar datos del tablero actual
            const dataLoaded = StorageController.load();
            if (!dataLoaded) {
                window.proyectosData = [];
            }
            renderTable();
            StorageController.loadCollapsedStates();
        }

        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>