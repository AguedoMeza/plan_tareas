<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Proyectos</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body>
    <!-- Botones de acciones principales -->
    <div class="mb-3 d-flex gap-2">
        <button type="button" class="btn btn-primary btn-lg" onclick="openCreateModal()">
            <i class="bi bi-plus-circle me-2"></i>Crear Nuevo
        </button>
        <button type="button" class="btn btn-outline-success btn-lg" onclick="StorageController.exportStorage()">
            <i class="bi bi-download me-2"></i>Exportar Tablero
        </button>
        <label class="btn btn-outline-info btn-lg mb-0" style="cursor:pointer;">
            <i class="bi bi-upload me-2"></i>Importar Tablero
            <input type="file" id="importStorageInput" accept="application/json" style="display:none;" onchange="StorageController.importStorage(event)">
        </label>
    </div>

    <!-- Incluir Modal de Creaci√≥n -->
    <div id="modalContainer"></div>

    <div class="container">
        <table id="projectTable">
            <thead>
                <tr>
                    <th>Proyecto</th>
                    <th>Tarea</th>
                    <th>Descripci√≥n breve</th>
                    <th>Prioridad</th>
                    <th>Avance</th>
                    <th>Esfuerzo (d√≠as/semanas)</th>
                    <th>DeadLine</th>
                    <th>Estado</th>
                    <th style="width: 60px;">Acciones</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Cargar los datos de proyectos y reglas de negocio desde archivo externo -->
    <script src="proyectosData.js"></script>
    <script src="reglasNegocio.js"></script>
    <script src="storageController.js"></script>
    <script src="formController.js"></script>
    <script>
        // Funci√≥n para renderizar la tabla
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            window.proyectosData.forEach((proyecto, index) => {
                // Fila del proyecto
                const proyectoRow = document.createElement('tr');
                proyectoRow.className = 'proyecto-row';
                proyectoRow.dataset.projectIndex = index;
                proyectoRow.innerHTML = `
                    <td class="proyecto-nombre" data-field="nombre">
                        <div class="project-controls">
                            <button class="reorder-btn" onclick="moveProject(${index}, 'up')" id="up-${index}" title="Mover proyecto hacia arriba" ${index === 0 ? 'disabled' : ''}>
                                ‚Üë
                            </button>
                            <button class="reorder-btn" onclick="moveProject(${index}, 'down')" id="down-${index}" title="Mover proyecto hacia abajo" ${index === window.proyectosData.length - 1 ? 'disabled' : ''}>
                                ‚Üì
                            </button>
                            <button class="collapse-btn" onclick="StorageController.toggleProjectPersistent(${index})" id="btn-${index}" title="Contraer/Expandir proyecto">
                                <span class="collapse-icon">‚ñº</span>
                            </button>
                        </div>
                        ${proyecto.nombre}
                    </td>
                    <td colspan="2" class="descripcion-proyecto" data-field="descripcion">${proyecto.descripcion}</td>
                    <td colspan="5"></td>
                    <td class="actions-cell">
                        <div class="dropdown">
                            <button class="btn action-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                ‚öôÔ∏è
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" onclick="StorageController.editRow('project', ${index})">‚úèÔ∏è Editar</a></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="StorageController.deleteRow('project', ${index})">üóëÔ∏è Eliminar</a></li>
                            </ul>
                        </div>
                    </td>
                `;
                tbody.appendChild(proyectoRow);

                // Calcular avance general usando la capa de negocio
                let avanceGeneral = window.reglasNegocio.calcularAvanceGeneral(proyecto);

                // Fila del recuento con avance general
                const recuentoRow = document.createElement('tr');
                recuentoRow.className = 'recuento-row';
                recuentoRow.dataset.projectIndex = index;
                recuentoRow.innerHTML = `
                    <td>Recuento: ${proyecto.recuento}</td>
                    <td colspan="2">Avance general: <strong>${avanceGeneral}%</strong></td>
                    <td colspan="5"></td>
                    <td></td>
                `;
                tbody.appendChild(recuentoRow);

                // Filas de tareas
                proyecto.tareas.forEach((tarea, tareaIndex) => {
                    const tareaRow = document.createElement('tr');
                    // Si tiene subtareas, aplicar clase especial
                    tareaRow.className = Array.isArray(tarea.subtareas) ? 'tarea-row tarea-con-subtareas' : 'tarea-row';
                    tareaRow.dataset.projectIndex = index;
                    tareaRow.dataset.taskIndex = tareaIndex;

                    let estadoClass = 'estado-pendiente';
                    if (tarea.estado === 'Completado') estadoClass = 'estado-completado';
                    if (tarea.estado === 'En progreso') estadoClass = 'estado-progreso';
                    if (tarea.estado === 'Bloqueado') estadoClass = 'estado-bloqueado';

                    // Mostrar avance 100% si est√° completado y el campo est√° vac√≠o
                    let avanceMostrar = tarea.avance;
                    if (tarea.estado === 'Completado' && (!tarea.avance || tarea.avance.trim() === '')) {
                        avanceMostrar = '100%';
                    }

                    tareaRow.innerHTML = `
                        <td></td>
                        <td data-field="nombre"><span style="display:inline-block;vertical-align:middle;">${Array.isArray(tarea.subtareas) ? '<span style=\'font-size:18px;color:#4a5568;margin-right:4px;\'>üìÇ</span>' : ''}<strong>${tarea.nombre}</strong></span></td>
                        <td data-field="descripcion">${tarea.descripcion}</td>
                        <td class="prioridad" data-field="prioridad">${tarea.prioridad}</td>
                        <td class="avance" data-field="avance">${avanceMostrar}</td>
                        <td class="esfuerzo" data-field="esfuerzo">${tarea.esfuerzo}</td>
                        <td data-field="deadline">${tarea.deadline}</td>
                        <td data-field="estado">
                            <select class="form-select form-select-sm estado-select" 
                                    onchange="updateEstado('task', ${index}, ${tareaIndex}, null, this.value)"
                                    data-current="${tarea.estado}">
                                <option value="Pendiente" ${tarea.estado === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                                <option value="En progreso" ${tarea.estado === 'En progreso' ? 'selected' : ''}>En progreso</option>
                                <option value="Completado" ${tarea.estado === 'Completado' ? 'selected' : ''}>Completado</option>
                                <option value="Bloqueado" ${tarea.estado === 'Bloqueado' ? 'selected' : ''}>Bloqueado</option>
                            </select>
                        </td>
                        <td class="actions-cell">
                            <div class="dropdown">
                                <button class="btn btn-sm action-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    ‚öôÔ∏è
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" onclick="StorageController.editRow('task', ${index}, ${tareaIndex})">üìù Editar</a></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="StorageController.deleteRow('task', ${index}, ${tareaIndex})">üóëÔ∏è Eliminar</a></li>
                                </ul>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tareaRow);

                    // Si la tarea tiene subtareas, pintarlas con estilo especial
                    if (Array.isArray(tarea.subtareas)) {
                        tarea.subtareas.forEach((subtarea, subtareaIndex) => {
                            const subRow = document.createElement('tr');
                            subRow.className = 'subtarea-row';
                            subRow.dataset.projectIndex = index;
                            subRow.dataset.taskIndex = tareaIndex;
                            subRow.dataset.subtaskIndex = subtareaIndex;

                            let subEstadoClass = 'estado-pendiente';
                            if (subtarea.estado === 'Completado') subEstadoClass = 'estado-completado';
                            if (subtarea.estado === 'En progreso') subEstadoClass = 'estado-progreso';
                            if (subtarea.estado === 'Bloqueado') subEstadoClass = 'estado-bloqueado';

                            let subAvanceMostrar = subtarea.avance;
                            if (subtarea.estado === 'Completado' && (!subtarea.avance || subtarea.avance.trim() === '')) {
                                subAvanceMostrar = '100%';
                            }

                            subRow.innerHTML = `
                                <td></td>
                                <td class="subtarea-nombre" data-field="nombre">üìÑ ${subtarea.nombre}</td>
                                <td data-field="descripcion">${subtarea.descripcion}</td>
                                <td class="prioridad" data-field="prioridad">${subtarea.prioridad}</td>
                                <td class="avance" data-field="avance">${subAvanceMostrar}</td>
                                <td class="esfuerzo" data-field="esfuerzo">${subtarea.esfuerzo}</td>
                                <td data-field="deadline">${subtarea.deadline}</td>
                                <td data-field="estado">
                                    <select class="form-select form-select-sm estado-select" 
                                            onchange="updateEstado('subtask', ${index}, ${tareaIndex}, ${subtareaIndex}, this.value)"
                                            data-current="${subtarea.estado}">
                                        <option value="Pendiente" ${subtarea.estado === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                                        <option value="En progreso" ${subtarea.estado === 'En progreso' ? 'selected' : ''}>En progreso</option>
                                        <option value="Completado" ${subtarea.estado === 'Completado' ? 'selected' : ''}>Completado</option>
                                        <option value="Bloqueado" ${subtarea.estado === 'Bloqueado' ? 'selected' : ''}>Bloqueado</option>
                                    </select>
                                </td>
                                <td class="actions-cell">
                                    <div class="dropdown">
                                        <button class="btn btn-sm action-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            ‚öôÔ∏è
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item" href="#" onclick="StorageController.editRow('subtask', ${index}, ${tareaIndex}, ${subtareaIndex})">üìù Editar</a></li>
                                            <li><a class="dropdown-item text-danger" href="#" onclick="StorageController.deleteRow('subtask', ${index}, ${tareaIndex}, ${subtareaIndex})">üóëÔ∏è Eliminar</a></li>
                                        </ul>
                                    </div>
                                </td>
                            `;
                            tbody.appendChild(subRow);
                        });
                    }
                });
            });
        }

        // Funci√≥n para colapsar/expandir proyectos
        function toggleProject(index) {
            const projectRow = document.querySelector(`tr.proyecto-row[data-project-index="${index}"]`);
            const button = document.getElementById(`btn-${index}`);
            const icon = button.querySelector('.collapse-icon');
            const relatedRows = document.querySelectorAll(`tr[data-project-index="${index}"]:not(.proyecto-row)`);
            
            if (projectRow.classList.contains('proyecto-collapsed')) {
                // Expandir
                projectRow.classList.remove('proyecto-collapsed');
                icon.textContent = '‚ñº';
                button.title = 'Contraer proyecto';
                relatedRows.forEach(row => {
                    row.style.display = '';
                });
            } else {
                // Colapsar
                projectRow.classList.add('proyecto-collapsed');
                icon.textContent = '‚ñ∂';
                button.title = 'Expandir proyecto';
                relatedRows.forEach(row => {
                    row.style.display = 'none';
                });
            }
        }

        // Funci√≥n para reordenar proyectos
        function moveProject(index, direction) {
            const currentProject = window.proyectosData[index];
            let newIndex;
            
            if (direction === 'up' && index > 0) {
                newIndex = index - 1;
            } else if (direction === 'down' && index < window.proyectosData.length - 1) {
                newIndex = index + 1;
            } else {
                return; // No se puede mover
            }
            
            // Intercambiar proyectos en el array
            const projectToSwap = window.proyectosData[newIndex];
            window.proyectosData[index] = projectToSwap;
            window.proyectosData[newIndex] = currentProject;
            
            // Guardar estados de colapso antes de re-renderizar
            const collapsedStates = {};
            window.proyectosData.forEach((_, i) => {
                const projectRow = document.querySelector(`tr.proyecto-row[data-project-index="${i}"]`);
                if (projectRow) {
                    collapsedStates[i] = projectRow.classList.contains('proyecto-collapsed');
                }
            });
            
            // Re-renderizar la tabla
            renderTable();
            
            // Restaurar estados de colapso (intercambiados)
            const tempCollapsed = collapsedStates[index];
            collapsedStates[index] = collapsedStates[newIndex];
            collapsedStates[newIndex] = tempCollapsed;
            
            Object.keys(collapsedStates).forEach(i => {
                if (collapsedStates[i]) {
                    toggleProject(parseInt(i));
                }
            });
            
            // Guardar los nuevos estados de colapso
            setTimeout(() => {
                StorageController.saveCollapsedStates();
            }, 100);
            
            // Agregar efecto visual de movimiento
            const movedProjectRow = document.querySelector(`tr.proyecto-row[data-project-index="${newIndex}"]`);
            if (movedProjectRow) {
                movedProjectRow.classList.add('move-animation');
                setTimeout(() => {
                    movedProjectRow.classList.remove('move-animation');
                }, 300);
            }
            
            // Guardar cambios en el storage
            StorageController.save();
            
            // Mostrar feedback visual
            showMoveConfirmation(currentProject.nombre, direction);
        }



        // Funci√≥n para mostrar confirmaci√≥n de movimiento
        function showMoveConfirmation(projectName, direction) {
            const message = `Proyecto "${projectName}" movido hacia ${direction === 'up' ? 'arriba' : 'abajo'}`;
            StorageController.notify(message, 'success');
        }

        // Funci√≥n para actualizar estado (wrapper global)
        function updateEstado(type, projectIndex, taskIndex, subtaskIndex, newEstado) {
            StorageController.updateEstado(type, projectIndex, taskIndex, subtaskIndex, newEstado);
        }

        // Funci√≥n para abrir modal de creaci√≥n
        async function openCreateModal() {
            try {
                // Cargar el HTML del modal si no est√° cargado
                const modalContainer = document.getElementById('modalContainer');
                if (!modalContainer.innerHTML.trim()) {
                    const response = await fetch('create-forms.html');
                    const html = await response.text();
                    modalContainer.innerHTML = html;
                    
                    // Inicializar el FormController despu√©s de cargar el HTML
                    if (window.FormController) {
                        window.FormController.init();
                    }
                }
                
                // Abrir el modal
                if (window.FormController) {
                    window.FormController.openModal('project');
                }
            } catch (error) {
                console.error('Error al cargar el modal:', error);
                StorageController.notify('Error al cargar el formulario de creaci√≥n', 'error');
            }
        }

        // Inicializar la aplicaci√≥n al cargar la p√°gina
        

        // Funci√≥n para cancelar edici√≥n
        function cancelEdit() {
            if (!currentlyEditing) return;
            
            // Re-renderizar para restaurar estado original
            renderTable();
            currentlyEditing = null;
        }

        // Funci√≥n para eliminar elemento
        function deleteRow(type, projectIndex, taskIndex = null, subtaskIndex = null) {
            let itemName = '';
            let confirmMessage = '';
            
            // Determinar qu√© se va a eliminar
            if (type === 'project') {
                itemName = window.proyectosData[projectIndex].nombre;
                confirmMessage = `¬øEst√°s seguro de que deseas eliminar el proyecto "${itemName}" y todas sus tareas?`;
            } else if (type === 'task') {
                itemName = window.proyectosData[projectIndex].tareas[taskIndex].nombre;
                confirmMessage = `¬øEst√°s seguro de que deseas eliminar la tarea "${itemName}"${window.proyectosData[projectIndex].tareas[taskIndex].subtareas ? ' y todas sus subtareas' : ''}?`;
            } else if (type === 'subtask') {
                itemName = window.proyectosData[projectIndex].tareas[taskIndex].subtareas[subtaskIndex].nombre;
                confirmMessage = `¬øEst√°s seguro de que deseas eliminar la subtarea "${itemName}"?`;
            }
            
            // Mostrar confirmaci√≥n
            if (confirm(confirmMessage)) {
                try {
                    if (type === 'project') {
                        window.proyectosData.splice(projectIndex, 1);
                    } else if (type === 'task') {
                        window.proyectosData[projectIndex].tareas.splice(taskIndex, 1);
                        // Actualizar recuento del proyecto
                        window.proyectosData[projectIndex].recuento = window.proyectosData[projectIndex].tareas.length;
                    } else if (type === 'subtask') {
                        window.proyectosData[projectIndex].tareas[taskIndex].subtareas.splice(subtaskIndex, 1);
                        // Si no quedan subtareas, eliminar el array
                        if (window.proyectosData[projectIndex].tareas[taskIndex].subtareas.length === 0) {
                            delete window.proyectosData[projectIndex].tareas[taskIndex].subtareas;
                        }
                    }
                    
                    // Guardar cambios
                    StorageController.save();
                    StorageController.notify(`${type === 'project' ? 'Proyecto' : type === 'task' ? 'Tarea' : 'Subtarea'} "${itemName}" eliminado correctamente`, 'success');
                    
                    // Re-renderizar tabla
                    renderTable();
                    
                } catch (error) {
                    console.error('Error al eliminar:', error);
                    StorageController.notify('Error al eliminar el elemento', 'error');
                }
            }
        }

        // Funci√≥n auxiliar para escapar HTML
        function escapeHtml(text) {
            // Manejar valores null, undefined o vac√≠os
            if (text === null || text === undefined) {
                return '';
            }
            
            // Convertir a string si no lo es
            const str = String(text);
            
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return str.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Inicializar la aplicaci√≥n al cargar la p√°gina
        function initializeApp() {
            // Intentar cargar datos guardados, si no existen usar los originales
            StorageController.load();
            renderTable();
            
            // Cargar estados de colapso guardados
            StorageController.loadCollapsedStates();
        }

        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>